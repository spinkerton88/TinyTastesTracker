name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  SCHEME: TinyTastesTracker
  PLATFORM: iOS Simulator
  DEVICE: iPhone 15 Pro

jobs:
  # NEW: Firestore Rules Testing Job
  firestore-rules:
    name: Test Firestore Security Rules
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      working-directory: TinyTastesTracker
      run: npm ci

    - name: Install Firebase Tools
      run: npm install -g firebase-tools

    - name: Run Firestore Rules Tests
      working-directory: TinyTastesTracker
      run: npm run test:rules

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firestore-rules-test-results
        path: TinyTastesTracker/test-results/

  test:
    name: Run Tests
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Install XcodeGen
      run: |
        brew install xcodegen

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Generate Xcode Project
      working-directory: TinyTastesTracker
      run: xcodegen generate

    - name: Install SwiftLint
      run: |
        brew install swiftlint

    - name: Run SwiftLint
      working-directory: TinyTastesTracker
      run: swiftlint lint --reporter github-actions-logging

    - name: Build App
      working-directory: TinyTastesTracker
      run: |
        xcodebuild clean build \
          -scheme "$SCHEME" \
          -destination "platform=$PLATFORM,name=$DEVICE" \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty

    - name: Run Unit Tests
      working-directory: TinyTastesTracker
      run: |
        xcodebuild test \
          -scheme "$SCHEME" \
          -destination "platform=$PLATFORM,name=$DEVICE" \
          -derivedDataPath ./DerivedData \
          -enableCodeCoverage YES \
          -resultBundlePath ./TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --report html --output ./test-results.html

    - name: Generate Code Coverage
      working-directory: TinyTastesTracker
      run: |
        xcrun xccov view --report --json ./TestResults.xcresult > coverage.json
        xcrun xccov view --report ./TestResults.xcresult > coverage.txt

    - name: Display Coverage Summary
      working-directory: TinyTastesTracker
      run: |
        echo "üìä Code Coverage Summary:"
        cat coverage.txt

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./TinyTastesTracker/coverage.json
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          TinyTastesTracker/test-results.html
          TinyTastesTracker/coverage.txt
          TinyTastesTracker/TestResults.xcresult

    - name: Comment PR with Coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = fs.readFileSync('TinyTastesTracker/coverage.txt', 'utf8');
          const body = `## üìä Test Coverage Report\n\n\`\`\`\n${coverage}\n\`\`\``;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  lint:
    name: Code Quality Checks
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      working-directory: TinyTastesTracker
      run: |
        swiftlint lint --strict --reporter github-actions-logging

    - name: Install SwiftFormat
      run: brew install swiftformat

    - name: Check SwiftFormat
      working-directory: TinyTastesTracker
      run: |
        swiftformat --lint .

  security:
    name: Security Scan
    runs-on: macos-14
    needs: firestore-rules  # Wait for Firestore rules tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for hardcoded secrets
      run: |
        if grep -r "AIza[0-9A-Za-z\-_]{35}" TinyTastesTracker/ --exclude-dir=DerivedData --exclude-dir=.build --exclude-dir=node_modules; then
          echo "‚ö†Ô∏è WARNING: Potential API key found in code!"
          exit 1
        else
          echo "‚úÖ No hardcoded API keys detected"
        fi

    - name: Check for force unwraps in production code
      run: |
        FORCE_UNWRAPS=$(grep -r "!" TinyTastesTracker/TinyTastesTracker --include="*.swift" --exclude-dir=Tests | grep -v "// swiftlint:disable:next force_unwrapping" | wc -l)
        echo "Force unwraps found: $FORCE_UNWRAPS"
        if [ $FORCE_UNWRAPS -gt 0 ]; then
          echo "‚ö†Ô∏è WARNING: Force unwraps detected in production code"
          grep -r "!" TinyTastesTracker/TinyTastesTracker --include="*.swift" --exclude-dir=Tests | grep -v "// swiftlint:disable:next force_unwrapping" || true
        fi

    - name: Security Summary
      run: |
        echo "üîí Security Scan Complete"
        echo "‚úÖ Firestore rules tests passed"
        echo "‚úÖ No hardcoded secrets detected"
