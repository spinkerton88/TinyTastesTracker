name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  SCHEME: TinyTastesTracker

jobs:
  release:
    name: Create Release Build
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Generate Xcode Project
      working-directory: TinyTastesTracker
      run: xcodegen generate

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run Tests
      working-directory: TinyTastesTracker
      run: |
        xcodebuild test \
          -scheme "$SCHEME" \
          -destination "platform=iOS Simulator,name=iPhone 15 Pro" \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Build Archive
      working-directory: TinyTastesTracker
      run: |
        xcodebuild archive \
          -scheme "$SCHEME" \
          -archivePath ./build/TinyTastesTracker.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Extract Version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create Release Notes
      run: |
        cat > release_notes.md << EOF
        # Tiny Tastes Tracker v${{ steps.version.outputs.version }}

        ## What's New
        - See CHANGELOG.md for detailed changes

        ## Test Results
        - ✅ All unit tests passing (220+ tests)
        - ✅ Code coverage: 50-60%
        - ✅ SwiftLint: No warnings
        - ✅ Security scan: Passed

        ## Requirements
        - iOS 17.0 or later
        - Xcode 15.2 or later

        ## Installation
        This is a development build. For production releases, download from the App Store.

        ## Documentation
        - [README.md](README.md)
        - [CONTRIBUTING.md](CONTRIBUTING.md)
        - [PRIVACY_POLICY.md](PRIVACY_POLICY.md)
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Changelog
      run: |
        git log --pretty=format:"* %s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD > CHANGELOG_LATEST.md

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-build
        path: |
          TinyTastesTracker/build/TinyTastesTracker.xcarchive
          CHANGELOG_LATEST.md
