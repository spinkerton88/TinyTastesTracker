rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user has access to a profile
    function hasProfileAccess(profileId) {
      let profile = get(/databases/$(database)/documents/child_profiles/$(profileId)).data;
      return request.auth != null &&
             (profile.ownerId == request.auth.uid ||
              (profile.sharedWith != null && profile.sharedWith.hasAny([request.auth.uid])));
    }

    // Helper function to check if user owns a profile
    function isProfileOwner(profileId) {
      let profile = get(/databases/$(database)/documents/child_profiles/$(profileId)).data;
      return request.auth != null && profile.ownerId == request.auth.uid;
    }

    // ============================================
    // CHILD PROFILES
    // ============================================
    match /child_profiles/{profileId} {
      // Read: Any authenticated user can read (needed for invitation acceptance)
      // In a family sharing app, profiles are meant to be collaborative
      allow read: if request.auth != null;

      // Create: Any authenticated user (they become the owner)
      allow create: if request.auth != null &&
                       request.resource.data.ownerId == request.auth.uid;

      // Update: Owner OR anyone in sharedWith array OR accepting invitation
      // Case 1: Owner can update anything
      // Case 2: Shared users can update, but not ownership/sharing fields
      // Case 3: Anyone can add themselves to sharedWith (for invitation acceptance)
      allow update: if request.auth != null && (
        // Case 1: Owner can do anything
        resource.data.ownerId == request.auth.uid ||

        // Case 2: Shared users can update (but not ownership/sharing)
        (resource.data.sharedWith != null &&
         resource.data.sharedWith.hasAny([request.auth.uid]) &&
         request.resource.data.ownerId == resource.data.ownerId &&
         request.resource.data.sharedWith == resource.data.sharedWith) ||

        // Case 3: User adding themselves to sharedWith (invitation acceptance)
        (request.resource.data.sharedWith != null &&
         request.resource.data.sharedWith.hasAny([request.auth.uid]) &&
         !resource.data.sharedWith.hasAny([request.auth.uid]) &&
         request.resource.data.ownerId == resource.data.ownerId)
      );

      // Delete: Only owner can delete
      allow delete: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;
    }

    // ============================================
    // PROFILE INVITATIONS
    // ============================================
    match /profile_invitations/{invitationId} {
      // Read: Inviter OR invited email matches authenticated user's email
      // OR any authenticated user (needed for invite code lookup)
      allow read: if request.auth != null;

      // Create: Any authenticated user can invite
      allow create: if request.auth != null &&
                       request.resource.data.invitedBy == request.auth.uid;

      // Update: Inviter can update anything, OR anyone can mark as accepted/declined
      // (since they need the code to find it, it's secure)
      allow update: if request.auth != null && (
        resource.data.invitedBy == request.auth.uid ||
        (request.resource.data.status == 'accepted' || request.resource.data.status == 'declined')
      );

      // Delete: Only inviter can delete (cancel invitation)
      allow delete: if request.auth != null &&
                       resource.data.invitedBy == request.auth.uid;
    }

    // ============================================
    // MEAL LOGS (Toddler/Explorer Mode)
    // ============================================
    match /meal_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.childId);
    }

    // ============================================
    // TRIED FOOD LOGS
    // ============================================
    match /tried_food_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.childId);
    }

    // ============================================
    // SLEEP LOGS (Newborn Mode)
    // ============================================
    match /sleep_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // NURSING LOGS
    // ============================================
    match /nursing_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // DIAPER LOGS
    // ============================================
    match /diaper_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // BOTTLE FEED LOGS
    // ============================================
    match /bottle_feed_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // PUMPING LOGS
    // ============================================
    match /pumping_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // MEDICATION LOGS
    // ============================================
    match /medication_logs/{logId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // SAVED MEDICATIONS (Owner-specific)
    // ============================================
    match /saved_medications/{medicationId} {
      allow read, write: if request.auth != null &&
                            resource.data.ownerId == request.auth.uid;
    }

    // ============================================
    // GROWTH MEASUREMENTS
    // ============================================
    match /growth_measurements/{measurementId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.babyId);
    }

    // ============================================
    // RECIPES (Shareable via profile collaboration)
    // ============================================
    match /recipes/{recipeId} {
      allow read: if request.auth != null &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.sharedWith != null &&
                       resource.data.sharedWith.hasAny([request.auth.uid])));

      allow create, delete: if request.auth != null &&
                               resource.data.ownerId == request.auth.uid;

      // Allow update if owner, already shared, OR adding yourself to sharedWith
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.sharedWith != null &&
         resource.data.sharedWith.hasAny([request.auth.uid])) ||
        // Allow adding yourself to sharedWith (for invitation acceptance)
        (request.resource.data.sharedWith != null &&
         request.resource.data.sharedWith.hasAny([request.auth.uid]) &&
         (resource.data.sharedWith == null || !resource.data.sharedWith.hasAny([request.auth.uid])))
      );
    }

    // ============================================
    // CUSTOM FOODS (Shareable via profile collaboration)
    // ============================================
    match /custom_foods/{foodId} {
      allow read: if request.auth != null &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.sharedWith != null &&
                       resource.data.sharedWith.hasAny([request.auth.uid])));

      allow create, delete: if request.auth != null &&
                               resource.data.ownerId == request.auth.uid;

      // Allow update if owner, already shared, OR adding yourself to sharedWith
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.sharedWith != null &&
         resource.data.sharedWith.hasAny([request.auth.uid])) ||
        // Allow adding yourself to sharedWith (for invitation acceptance)
        (request.resource.data.sharedWith != null &&
         request.resource.data.sharedWith.hasAny([request.auth.uid]) &&
         (resource.data.sharedWith == null || !resource.data.sharedWith.hasAny([request.auth.uid])))
      );
    }

    // ============================================
    // MEAL PLAN ENTRIES (Owner-specific)
    // ============================================
    match /meal_plan_entries/{entryId} {
      allow read, write: if request.auth != null &&
                            resource.data.ownerId == request.auth.uid;
    }

    // ============================================
    // SHOPPING LIST ITEMS (Shareable via profile collaboration)
    // ============================================
    match /shopping_list_items/{itemId} {
      allow read: if request.auth != null &&
                     (resource.data.ownerId == request.auth.uid ||
                      (resource.data.sharedWith != null &&
                       resource.data.sharedWith.hasAny([request.auth.uid])));

      allow create, delete: if request.auth != null &&
                               resource.data.ownerId == request.auth.uid;

      // Allow update if owner, already shared, OR adding yourself to sharedWith
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.sharedWith != null &&
         resource.data.sharedWith.hasAny([request.auth.uid])) ||
        // Allow adding yourself to sharedWith (for invitation acceptance)
        (request.resource.data.sharedWith != null &&
         request.resource.data.sharedWith.hasAny([request.auth.uid]) &&
         (resource.data.sharedWith == null || !resource.data.sharedWith.hasAny([request.auth.uid])))
      );
    }

    // ============================================
    // PEDIATRICIAN SUMMARIES
    // ============================================
    match /pediatrician_summaries/{summaryId} {
      allow read, write: if request.auth != null &&
                            resource.data.ownerId == request.auth.uid;
    }

    // ============================================
    // NUTRIENT GOALS
    // ============================================
    match /nutrient_goals/{goalId} {
      allow read, write: if request.auth != null &&
                            hasProfileAccess(resource.data.childId);
    }
  }
}
